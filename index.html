<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>WhatsApp Clone</title>
  <style>
    body { margin:0; font-family:Arial, sans-serif; background:#f0f2f5; }
    #app { display:flex; height:100vh; }
    #sidebar {
      width: 30%; max-width: 280px; background:#fff;
      border-right:1px solid #ddd; display:flex; flex-direction:column;
    }
    #sidebar h2 { margin:0; padding:10px; background:#075e54; color:#fff; }
    #userList, #groupList { flex:1; overflow-y:auto; padding:10px; }
    .userItem, .groupItem {
      padding:8px; cursor:pointer; border-bottom:1px solid #eee;
      display:flex; align-items:center; justify-content:space-between;
    }
    .userItem img, .groupItem img { width:30px; height:30px; border-radius:50%; margin-right:10px; }
    #chatArea { flex:1; display:flex; flex-direction:column; }
    #chatHeader { background:#075e54; color:#fff; padding:10px; }
    #messages { flex:1; padding:10px; overflow-y:auto; background:#e5ddd5; }
    .msg { margin:5px 0; padding:8px 12px; border-radius:10px; max-width:70%; clear:both; }
    .me { background:#dcf8c6; float:right; text-align:right; }
    .other { background:#fff; float:left; text-align:left; }
    #chatInput { display:flex; padding:10px; border-top:1px solid #ddd; background:#fff; }
    #chatInput input { flex:1; padding:10px; border:1px solid #ddd; border-radius:20px; }
    #chatInput button { margin-left:5px; background:#075e54; color:#fff; border:none; padding:10px 15px; border-radius:20px; cursor:pointer; }
    #authButtons { text-align:center; margin:10px; }
    #authButtons button { margin:5px; padding:8px 12px; border:none; cursor:pointer; border-radius:5px; background:#25d366; color:#fff; font-weight:bold; }
    #logoutBtn { background:#ff3b30 !important; }
    #profileEdit { padding:10px; border-top:1px solid #ddd; }
    #profileEdit input { width:90%; padding:5px; margin:5px 0; }
    #groupCreate { padding:10px; border-top:1px solid #ddd; }
    #groupCreate input { width:90%; padding:5px; margin:5px 0; }
    .btnSmall { padding:3px 6px; border:none; border-radius:3px; cursor:pointer; margin-left:5px; }
    .approve { background:#25d366; color:#fff; }
    .reject { background:#ff3b30; color:#fff; }
  </style>
</head>
<body>
<div id="app">
  <div id="sidebar">
    <h2>Chats</h2>
    <div id="authButtons">
      <button onclick="loginGoogle()">Login</button>
      <button id="logoutBtn" onclick="logout()">Logout</button>
    </div>
    <div id="profileEdit" style="display:none;">
      <input type="text" id="displayName" placeholder="Enter name">
      <input type="text" id="photoURL" placeholder="Photo URL">
      <button onclick="saveProfile()">Save</button>
    </div>
    <h3 style="margin:10px;">Users</h3>
    <div id="userList"></div>
    <h3 style="margin:10px;">Groups</h3>
    <div id="groupList"></div>
    <div id="groupCreate" style="display:none;">
      <input type="text" id="groupName" placeholder="Group Name">
      <input type="text" id="groupDesc" placeholder="Group Description">
      <button onclick="createGroup()">Create Group</button>
    </div>
  </div>
  <div id="chatArea">
    <div id="chatHeader">Select a chat</div>
    <div id="messages"></div>
    <div id="chatInput">
      <input type="text" id="messageInput" placeholder="Type a message..." />
      <button onclick="sendMessage()">Send</button>
    </div>
  </div>
</div>

<!-- Firebase SDK -->
<script src="https://www.gstatic.com/firebasejs/8.10.1/firebase-app.js"></script>
<script src="https://www.gstatic.com/firebasejs/8.10.1/firebase-auth.js"></script>
<script src="https://www.gstatic.com/firebasejs/8.10.1/firebase-firestore.js"></script>

<script>
  // Firebase Config
  const firebaseConfig = {
    apiKey: "AIzaSyBo2LX4YxwdZ6UMoo4TchkzPA5HjkSM7qQ",
    authDomain: "chat-da614.firebaseapp.com",
    projectId: "chat-da614",
    storageBucket: "chat-da614.appspot.com",
    messagingSenderId: "14850718256",
    appId: "1:14850718256:web:868f51a8123953e8bc0bf5"
  };
  firebase.initializeApp(firebaseConfig);
  const db = firebase.firestore();
  const auth = firebase.auth();

  let currentUser = null;
  let activeChat = null;

  // Auth state
  auth.onAuthStateChanged(user => {
    if (user) {
      currentUser = user;
      document.getElementById("profileEdit").style.display = "block";
      document.getElementById("groupCreate").style.display = "block";
      saveUserToDB(user);
      loadUsers();
      loadGroups();
    } else {
      currentUser = null;
      document.getElementById("profileEdit").style.display = "none";
      document.getElementById("groupCreate").style.display = "none";
    }
  });

  function loginGoogle() {
    const provider = new firebase.auth.GoogleAuthProvider();
    auth.signInWithPopup(provider);
  }
  function logout() { auth.signOut(); }

  // Save profile
  function saveProfile() {
    if (!currentUser) return;
    const name = document.getElementById("displayName").value || currentUser.displayName;
    const photo = document.getElementById("photoURL").value || currentUser.photoURL;
    db.collection("users").doc(currentUser.uid).set({
      uid: currentUser.uid,
      email: currentUser.email,
      displayName: name,
      photoURL: photo
    }, {merge:true});
  }

  // Save user
  function saveUserToDB(user) {
    db.collection("users").doc(user.uid).set({
      uid: user.uid,
      email: user.email,
      displayName: user.displayName || user.email,
      photoURL: user.photoURL || ""
    }, {merge:true});
  }

  // Load users
  function loadUsers() {
    db.collection("users").onSnapshot(snapshot => {
      const list = document.getElementById("userList");
      list.innerHTML = "";
      snapshot.forEach(doc => {
        const u = doc.data();
        if (currentUser && u.uid === currentUser.uid) return;
        const div = document.createElement("div");
        div.className = "userItem";
        div.innerHTML = `<img src="${u.photoURL || 'https://via.placeholder.com/30'}"> ${u.displayName || u.email}`;
        div.onclick = () => openChat(u.uid, u.displayName, false);
        list.appendChild(div);
      });
    });
  }

  // Load groups
  function loadGroups() {
    db.collection("groups").onSnapshot(snapshot => {
      const list = document.getElementById("groupList");
      list.innerHTML = "";
      snapshot.forEach(doc => {
        const g = doc.data();
        const div = document.createElement("div");
        div.className = "groupItem";
        let actions = "";
        if (g.members && g.members.includes(currentUser.uid)) {
          actions = "<span>‚úî Member</span>";
          div.onclick = () => openChat(g.id, g.name, true);
        } else if (g.requests && g.requests.includes(currentUser.uid)) {
          actions = "<span>‚è≥ Pending</span>";
        } else if (g.adminId === currentUser.uid) {
          actions = `<span>üëë Admin</span>`;
          if (g.requests) {
            g.requests.forEach(r => {
              actions += `<br><button class='btnSmall approve' onclick="approveMember('${g.id}','${r}')">Approve</button>
                          <button class='btnSmall reject' onclick="rejectMember('${g.id}','${r}')">Reject</button>`;
            });
          }
          div.onclick = () => openChat(g.id, g.name, true);
        } else {
          actions = `<button class='btnSmall' onclick="requestJoin('${g.id}')">Join</button>`;
        }
        div.innerHTML = `<span><img src="https://via.placeholder.com/30"> ${g.name}</span> ${actions}`;
        list.appendChild(div);
      });
    });
  }

  // Create group
  function createGroup() {
    if (!currentUser) return;
    const name = document.getElementById("groupName").value;
    const desc = document.getElementById("groupDesc").value;
    if (!name) return alert("Enter group name");
    const id = db.collection("groups").doc().id;
    db.collection("groups").doc(id).set({
      id:id,
      name:name,
      description:desc,
      adminId: currentUser.uid,
      members:[currentUser.uid],
      requests:[]
    });
    document.getElementById("groupName").value="";
    document.getElementById("groupDesc").value="";
  }

  // Request join
  function requestJoin(gid) {
    db.collection("groups").doc(gid).update({
      requests: firebase.firestore.FieldValue.arrayUnion(currentUser.uid)
    });
  }

  // Approve member
  function approveMember(gid, uid) {
    db.collection("groups").doc(gid).update({
      members: firebase.firestore.FieldValue.arrayUnion(uid),
      requests: firebase.firestore.FieldValue.arrayRemove(uid)
    });
  }

  // Reject member
  function rejectMember(gid, uid) {
    db.collection("groups").doc(gid).update({
      requests: firebase.firestore.FieldValue.arrayRemove(uid)
    });
  }

  // Open chat
  function openChat(id, name, isGroup) {
    activeChat = {id:id, name:name, isGroup:isGroup};
    document.getElementById("chatHeader").innerText = name;
    loadMessages();
  }

  // Send message
  function sendMessage() {
    const text = document.getElementById("messageInput").value;
    if (!text.trim() || !currentUser || !activeChat) return;
    db.collection("messages").add({
      chatId: activeChat.id,
      isGroup: activeChat.isGroup,
      from: currentUser.uid,
      fromName: currentUser.displayName || currentUser.email,
      text: text,
      timestamp: firebase.firestore.FieldValue.serverTimestamp()
    });
    document.getElementById("messageInput").value = "";
  }

  // Load messages
  function loadMessages() {
    if (!activeChat) return;
    db.collection("messages").where("chatId","==",activeChat.id).orderBy("timestamp")
      .onSnapshot(snapshot => {
        const box = document.getElementById("messages");
        box.innerHTML = "";
        snapshot.forEach(doc => {
          const m = doc.data();
          const css = (m.from===currentUser.uid) ? "me" : "other";
          box.innerHTML += `<div class="msg ${css}"><b>${m.fromName}</b><br>${m.text}</div>`;
        });
        box.scrollTop = box.scrollHeight;
      });
  }
</script>
</body>
</html>
