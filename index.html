<!DOCTYPE html>
<html>
<head>
  <meta charset="UTF-8">
  <title>Pro Chat</title>
  <script src="https://www.gstatic.com/firebasejs/9.6.1/firebase-app-compat.js"></script>
  <script src="https://www.gstatic.com/firebasejs/9.6.1/firebase-firestore-compat.js"></script>
  <style>
    body { font-family: Arial, sans-serif; margin: 0; padding: 0; background: #f4f4f4; }
    #login, #chatSection { max-width: 700px; margin: auto; padding: 20px; }
    h2 { margin-top: 0; }
    #users { border: 1px solid #ccc; padding: 10px; background: white; margin-bottom: 10px; }
    #messages { border: 1px solid #ccc; height: 300px; overflow-y: auto; padding: 10px; background: white; }
    #messageInput { width: 70%; padding: 8px; }
    button { padding: 8px; margin: 5px; cursor: pointer; }
    .msg { margin: 5px 0; }
    .me { text-align: right; }
    .read { font-size: 10px; color: green; }
    .unread { font-size: 10px; color: gray; }
  </style>
</head>
<body>
  <!-- Login -->
  <div id="login">
    <h2>Login</h2>
    <input type="text" id="username" placeholder="Enter your name" /><br>
    <input type="text" id="bio" placeholder="Enter short bio" /><br>
    <button onclick="login()">Login</button>
  </div>

  <!-- Chat Section -->
  <div id="chatSection" style="display:none;">
    <h2>Welcome <span id="userDisplay"></span></h2>
    <button onclick="openGroup()">Group Chat</button>
    <h3>Users</h3>
    <div id="users"></div>

    <h3 id="chatTitle">Chat</h3>
    <div id="messages"></div>
    <input type="text" id="messageInput" placeholder="Type a message" />
    <button onclick="sendMessage()">Send</button>
  </div>

  <script>
    // Firebase config
    const firebaseConfig = {
      apiKey: "AIzaSyBo2LX4YxwdZ6UMoo4TchkzPA5HjkSM7qQ",
      authDomain: "chat-da614.firebaseapp.com",
      projectId: "chat-da614",
      storageBucket: "chat-da614.appspot.com",
      messagingSenderId: "14850718256",
      appId: "1:14850718256:web:868f51a8123953e8bc0bf5"
    };

    firebase.initializeApp(firebaseConfig);
    const db = firebase.firestore();

    let currentUser = null;
    let currentBio = "";
    let currentChat = null;
    let unsubscribe = null;

    // Login and save profile
    function login() {
      const username = document.getElementById("username").value.trim();
      const bio = document.getElementById("bio").value.trim();
      if (!username) return alert("Enter a name");

      currentUser = username;
      currentBio = bio;
      document.getElementById("userDisplay").innerText = username;
      document.getElementById("login").style.display = "none";
      document.getElementById("chatSection").style.display = "block";

      // Save user profile
      db.collection("users").doc(username).set({
        name: username,
        bio: bio,
        lastSeen: Date.now()
      });

      loadUsers();
      openGroup(); // default chat
    }

    // Load all users
    function loadUsers() {
      db.collection("users").onSnapshot(snapshot => {
        let html = "";
        snapshot.forEach(doc => {
          if (doc.id !== currentUser) {
            const data = doc.data();
            html += `<div>
                      <button onclick="openChat('${doc.id}')">${doc.id}</button>
                      <small> - ${data.bio || ""}</small>
                    </div>`;
          }
        });
        document.getElementById("users").innerHTML = html;
      });
    }

    // Open Group Chat (with requests)
    function openGroup() {
      if (unsubscribe) unsubscribe();
      currentChat = "group";
      document.getElementById("chatTitle").innerText = "Group Chat";

      // Check if user is approved in group
      db.collection("groupRequests").doc(currentUser).get().then(doc => {
        if (!doc.exists) {
          db.collection("groupRequests").doc(currentUser).set({ status: "pending" });
          alert("Join request sent. Wait for admin approval.");
        } else if (doc.data().status === "approved") {
          loadMessages("group");
        } else {
          alert("Your group request is pending or denied.");
        }
      });
    }

    // Admin approves group join
    // (You can run this in console: approveUser('username'))
    function approveUser(user) {
      db.collection("groupRequests").doc(user).set({ status: "approved" });
    }

    // Open private chat
    function openChat(user) {
      if (unsubscribe) unsubscribe();
      const chatId = [currentUser, user].sort().join("_");
      currentChat = chatId;
      document.getElementById("chatTitle").innerText = "Chat with " + user;
      loadMessages(chatId);
    }

    // Load messages
    function loadMessages(chatId) {
      unsubscribe = db.collection("chats").doc(chatId).collection("messages")
        .orderBy("timestamp")
        .onSnapshot(snapshot => {
          let msgs = "";
          snapshot.forEach(doc => {
            const data = doc.data();
            const mine = data.sender === currentUser;
            const readStatus = data.read ? "✔✔" : "✔";
            msgs += `<div class="msg ${mine ? 'me' : ''}">
                      <b>${data.sender}:</b> ${data.text}
                      <span class="${data.read ? 'read' : 'unread'}">${readStatus}</span>
                     </div>`;
            // Mark as read if not mine
            if (!mine) {
              db.collection("chats").doc(chatId).collection("messages").doc(doc.id).update({ read: true });
            }
          });
          document.getElementById("messages").innerHTML = msgs;
          document.getElementById("messages").scrollTop = document.getElementById("messages").scrollHeight;
        });
    }

    // Send message
    function sendMessage() {
      const text = document.getElementById("messageInput").value.trim();
      if (!text || !currentChat) return;
      db.collection("chats").doc(currentChat).collection("messages").add({
        sender: currentUser,
        text: text,
        timestamp: Date.now(),
        read: false
      });
      document.getElementById("messageInput").value = "";
    }
  </script>
</body>
</html>
